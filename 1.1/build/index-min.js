/*! reflection - v1.1 - 2013-05-08 7:47:55 PM
* Copyright (c) 2013 元泉; Licensed  */
KISSY.add("gallery/reflection/1.1/index",function(e,t,a){function r(e){var t=this;r.superclass.constructor.call(t,e)}function i(t,a){t.complete?a():e.Event.on(t,"load",a)}var l=e.DOM;return e.extend(r,a,{render:function(){var t=this,a=l.query(t.get("selector"));e.each(a,function(e){i(e,function(){var a=parseFloat(l.attr(e,"data-rheight"))||t.get("height"),r=parseFloat(l.attr(e,"data-ropacity"))||t.get("opacity");t.add(e,{height:a,opacity:r})})})},add:function(e,t){this.remove(e);var a=l.create("<canvas></canvas>");"getContext"in a?this.renderByCanvas(a,e,t):this.renderByFilter(e,t)},renderByCanvas:function(e,t,a){var r=l.create("<div></div>"),i=t,s=i.className,o=Math.floor(i.height*a.height),n=Math.floor(i.height*(1+a.height)),h=i.width;r.className=s,i.className="reflected",r.style.cssText=i.style.cssText,i.style.cssText="vertical-align: bottom",e.height=o,e.width=h,r.style.width=h+"px",r.style.height=n+"px",i.parentNode.replaceChild(r,i),r.appendChild(i),r.appendChild(e);var c=e.getContext("2d");c.save(),c.translate(0,i.height-1),c.scale(1,-1),c.drawImage(i,0,0,h,i.height),c.restore(),c.globalCompositeOperation="destination-out";var d=c.createLinearGradient(0,0,0,o);d.addColorStop(0,"rgba(255, 255, 255, "+(1-a.opacity)+")"),d.addColorStop(1,"rgba(255, 255, 255, 1.0)"),c.fillStyle=d,c.rect(0,0,h,o),c.fill()},renderByFilter:function(e,t){var a=l.create("<div></div>"),r=e,i=r.className,s=Math.floor(r.height*t.height),o=Math.floor(r.height*(1+t.height)),n=r.width;"A"==r.parentElement.tagName&&(a=l.create("<a></a>"),a.href=r.parentElement.href),a.className=i,r.className="reflected",a.style.cssText=r.style.cssText,r.style.cssText="vertical-align: bottom";var h=new Image;h.onload=function(){h.style.width=n+"px",h.style.display="block",h.style.height=r.height+"px",h.style.marginBottom="-"+(r.height-s)+"px";var e="flipv progid:DXImageTransform.Microsoft.Alpha(opacity="+100*t.opacity+", style=1, finishOpacity=0, startx=0, starty=0, finishx=0, finishy="+100*t.height+")";h.style.filter=e,a.style.width=n+"px",a.style.height=o+"px",r.parentNode.replaceChild(a,r),a.appendChild(r),a.appendChild(h)},h.src=r.src},removeAll:function(){var t=l.query(".reflected"),a=this;e.each(t,function(e){a.remove(e)})},remove:function(e){e=l.get(e),e&&"reflected"==e.className&&(e.className=e.parentNode.className,e.parentNode.parentNode.replaceChild(e,e.parentNode))}},{ATTRS:{height:{value:.5},opacity:{value:.5},selector:{value:".reflect"}}}),r},{requires:["node","base"]});